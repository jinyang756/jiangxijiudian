# 完整数据库初始化指南

本文档介绍了如何使用 `complete-database-init.sql` 脚本对江西酒店菜单系统进行完整的数据库初始化。

## 脚本功能

该脚本提供了比基础初始化脚本更全面的数据库设置，包括：

1. **扩展安装** - 自动安装 pgcrypto 扩展
2. **完整表结构** - 包含所有必要的表和字段
3. **索引优化** - 为提高查询性能创建的索引
4. **RLS策略** - 行级安全策略确保数据访问安全
5. **审计功能** - 自动记录数据变更的审计日志
6. **API密钥管理** - 安全的API密钥生成和存储机制
7. **时间戳管理** - 自动更新记录的创建和修改时间

## 表结构说明

### 核心表
- `categories` - 菜品分类表
- `dishes` - 菜品信息表
- `orders` - 订单信息表
- `service_requests` - 服务请求表

### 辅助表
- `_staging_dishes` - 数据导入暂存表
- `transaction_account_ledger` - 交易账本表
- `example_audit_logs` - 审计日志表
- `api_keys` - API密钥管理表
- `operation_logs` - 操作日志表

## 使用方法

### 1. 前置条件
确保已安装 PostgreSQL 客户端工具，并且可以连接到数据库。

### 2. 执行脚本
```bash
# 使用 npm 脚本执行
npm run init-db-complete

# 或者直接使用 psql 命令执行
psql -f sql/complete-database-init.sql
```

### 3. 验证执行结果
执行完成后，可以通过以下方式验证数据库结构：

```bash
# 查看所有表
psql -c "\dt"

# 查看索引
psql -c "\di"

# 查看RLS策略
psql -c "SELECT * FROM pg_policy;"
```

## 安全特性

### RLS策略
脚本为所有表启用了行级安全（RLS），并配置了适当的访问策略：

- `categories` 和 `dishes` 表允许认证用户读取和插入数据
- `api_keys` 表只允许所有者访问自己的密钥
- `_staging_dishes` 表禁止公共访问
- `example_audit_logs` 表只允许管理员读取

### API密钥安全
API密钥以哈希形式存储，不保存明文密钥，确保安全性。

### 审计日志
自动记录所有对 `dishes` 表的增删改操作，便于追踪数据变更历史。

## 注意事项

1. **执行权限** - 执行脚本需要足够的数据库权限
2. **现有数据** - 脚本使用 `IF NOT EXISTS` 语句，不会影响现有数据
3. **扩展依赖** - 脚本会自动安装 pgcrypto 扩展
4. **生产环境** - 在生产环境中执行前，请先在测试环境中验证

## 故障排除

### 常见问题
1. **权限不足** - 确保使用的数据库用户具有创建表、索引、策略等权限
2. **扩展安装失败** - 检查数据库是否支持 pgcrypto 扩展
3. **RLS策略冲突** - 如果已有同名策略，可能需要手动删除后重新执行

### 验证脚本执行
如果需要验证脚本是否正确执行，可以检查以下内容：
- 表是否正确创建
- 索引是否正确创建
- RLS策略是否正确应用
- 函数是否正确创建

---
*文档最后更新于 2025年11月27日*