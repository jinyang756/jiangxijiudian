<!DOCTYPE html>
<html>
<head>
    <title>Supabase è¿æ¥æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .test-result.success { background: #e8f5e9; border: 1px solid #4caf50; }
        .test-result.error { background: #ffebee; border: 1px solid #f44336; }
        .test-result.warning { background: #fff3e0; border: 1px solid #ff9800; }
    </style>
</head>
<body>
    <h1>Supabase è¿æ¥æµ‹è¯•</h1>
    <div id="loading">æ­£åœ¨æµ‹è¯•è¿æ¥...</div>
    <div id="results" style="display: none;"></div>

    <script type="module">
        // æµ‹è¯• Supabase è¿æ¥
        async function testSupabaseConnection() {
            const loadingDiv = document.getElementById('loading');
            const resultsDiv = document.getElementById('results');
            
            try {
                // æ˜¾ç¤ºç¯å¢ƒå˜é‡ä¿¡æ¯
                const envVars = {
                    'VITE_APP_DB_URL': import.meta.env.VITE_APP_DB_URL,
                    'VITE_APP_DB_POSTGRES_PASSWORD': import.meta.env.VITE_APP_DB_POSTGRES_PASSWORD
                };
                
                let resultsHTML = '<h2>ç¯å¢ƒå˜é‡æ£€æŸ¥</h2>';
                
                if (envVars['VITE_APP_DB_URL'] && envVars['VITE_APP_DB_POSTGRES_PASSWORD']) {
                    resultsHTML += `<div class="test-result success">
                        <p>âœ… ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®</p>
                        <p><strong>Supabase URL:</strong> ${envVars['VITE_APP_DB_URL']}</p>
                        <p><strong>Supabase Key:</strong> ${envVars['VITE_APP_DB_POSTGRES_PASSWORD'].substring(0, 20)}... (å·²è®¾ç½®)</p>
                    </div>`;
                } else {
                    resultsHTML += `<div class="test-result error">
                        <p>âŒ ç¯å¢ƒå˜é‡æœªæ­£ç¡®è®¾ç½®</p>
                        <p>è¯·ç¡®ä¿åœ¨ Vercel é¡¹ç›®ä¸­è®¾ç½®äº†ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š</p>
                        <pre>VITE_APP_DB_URL=https://kdlhyzsihflwkwumxzfw.supabase.co
VITE_APP_DB_POSTGRES_PASSWORD=æ‚¨çš„Supabase Anon Key</pre>
                    </div>`;
                    loadingDiv.style.display = 'none';
                    resultsDiv.innerHTML = resultsHTML;
                    resultsDiv.style.display = 'block';
                    return;
                }
                
                // åŠ¨æ€å¯¼å…¥ Supabase å®¢æˆ·ç«¯
                resultsHTML += '<h2>Supabase å®¢æˆ·ç«¯æµ‹è¯•</h2>';
                resultsHTML += '<div class="test-result warning"><p>ğŸ”„ æ­£åœ¨åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯...</p></div>';
                resultsDiv.innerHTML = resultsHTML;
                resultsDiv.style.display = 'block';
                loadingDiv.style.display = 'none';
                
                // ç­‰å¾…ä¸€å°æ®µæ—¶é—´è®©ç”¨æˆ·çœ‹åˆ°åˆå§‹åŒ–è¿‡ç¨‹
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // å°è¯•åˆ›å»º Supabase å®¢æˆ·ç«¯
                const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js');
                
                resultsHTML = resultsHTML.replace(
                    '<div class="test-result warning"><p>ğŸ”„ æ­£åœ¨åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯...</p></div>',
                    '<div class="test-result success"><p>âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ</p></div>'
                );
                resultsDiv.innerHTML = resultsHTML;
                
                // åˆ›å»ºå®¢æˆ·ç«¯
                const supabase = createClient(
                    envVars['VITE_APP_DB_URL'],
                    envVars['VITE_APP_DB_POSTGRES_PASSWORD']
                );
                
                resultsHTML += '<div class="test-result warning"><p>ğŸ”„ æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥...</p></div>';
                resultsDiv.innerHTML = resultsHTML;
                
                // æµ‹è¯•è¿æ¥ - è·å–å½“å‰æ—¶é—´
                const { data, error } = await supabase.rpc('now');
                
                if (error) {
                    resultsHTML = resultsHTML.replace(
                        '<div class="test-result warning"><p>ğŸ”„ æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥...</p></div>',
                        `<div class="test-result error">
                            <p>âŒ æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥</p>
                            <p><strong>é”™è¯¯ä¿¡æ¯:</strong> ${error.message}</p>
                            <p>è¯·æ£€æŸ¥ï¼š</p>
                            <ul>
                                <li>Supabase URL æ˜¯å¦æ­£ç¡®</li>
                                <li>Supabase Anon Key æ˜¯å¦æ­£ç¡®ä¸”æœ‰æ•ˆ</li>
                                <li>ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸</li>
                            </ul>
                        </div>`
                    );
                } else {
                    resultsHTML = resultsHTML.replace(
                        '<div class="test-result warning"><p>ğŸ”„ æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥...</p></div>',
                        `<div class="test-result success">
                            <p>âœ… æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸ</p>
                            <p><strong>æ•°æ®åº“æ—¶é—´:</strong> ${data}</p>
                        </div>`
                    );
                    
                    // æµ‹è¯•è·å– categories è¡¨
                    resultsHTML += '<div class="test-result warning"><p>ğŸ”„ æ­£åœ¨æµ‹è¯•è¡¨è®¿é—®...</p></div>';
                    resultsDiv.innerHTML = resultsHTML;
                    
                    const { data: categories, error: categoriesError } = await supabase
                        .from('categories')
                        .select('*')
                        .limit(1);
                    
                    if (categoriesError) {
                        resultsHTML = resultsHTML.replace(
                            '<div class="test-result warning"><p>ğŸ”„ æ­£åœ¨æµ‹è¯•è¡¨è®¿é—®...</p></div>',
                            `<div class="test-result error">
                                <p>âŒ è¡¨è®¿é—®æµ‹è¯•å¤±è´¥</p>
                                <p><strong>é”™è¯¯ä¿¡æ¯:</strong> ${categoriesError.message}</p>
                                <p>è¿™å¯èƒ½æ˜¯å› ä¸ºæ•°æ®åº“è¡¨ä¸å­˜åœ¨æˆ–è§†å›¾æœªåˆ›å»ºã€‚</p>
                            </div>`
                        );
                    } else {
                        resultsHTML = resultsHTML.replace(
                            '<div class="test-result warning"><p>ğŸ”„ æ­£åœ¨æµ‹è¯•è¡¨è®¿é—®...</p></div>',
                            `<div class="test-result success">
                                <p>âœ… è¡¨è®¿é—®æµ‹è¯•æˆåŠŸ</p>
                                <p><strong>categories è¡¨:</strong> å¯è®¿é—® (${categories.length} æ¡è®°å½•)</p>
                            </div>`
                        );
                    }
                }
                
                resultsDiv.innerHTML = resultsHTML;
                
            } catch (error) {
                loadingDiv.style.display = 'none';
                resultsDiv.innerHTML = `<div class="test-result error">
                    <p>âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯</p>
                    <p><strong>é”™è¯¯ä¿¡æ¯:</strong> ${error.message}</p>
                    <p>è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚</p>
                </div>`;
                resultsDiv.style.display = 'block';
                console.error('æµ‹è¯•é”™è¯¯:', error);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹æµ‹è¯•
        document.addEventListener('DOMContentLoaded', testSupabaseConnection);
    </script>
</body>
</html>