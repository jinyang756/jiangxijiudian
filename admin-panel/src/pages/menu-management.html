<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>菜单管理 - 江西酒店管理面板</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">菜单管理</h1>
            <button id="add-dish-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                <i class="fas fa-plus mr-2"></i>添加菜品
            </button>
        </div>

        <!-- 分类筛选 -->
        <div class="mb-6">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="category-filter">
                按分类筛选
            </label>
            <select id="category-filter" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <option value="">所有分类</option>
                <!-- 分类选项将通过JavaScript动态添加 -->
            </select>
        </div>

        <!-- 菜品表格 -->
        <div class="bg-white shadow-md rounded-lg overflow-hidden">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">菜品ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">菜品名称</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分类</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">价格</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">属性</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                    </tr>
                </thead>
                <tbody id="dishes-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- 菜品数据将通过JavaScript动态添加 -->
                </tbody>
            </table>
        </div>

        <!-- 添加/编辑菜品模态框 -->
        <div id="dish-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4" id="modal-title">添加菜品</h3>
                    <form id="dish-form">
                        <input type="hidden" id="dish-id">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="dish-dish-id">
                                菜品ID
                            </label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                                   id="dish-dish-id" type="text" placeholder="例如: H1">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="dish-name-zh">
                                中文名称
                            </label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                                   id="dish-name-zh" type="text" placeholder="例如: 水煮牛肉">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="dish-name-en">
                                英文名称
                            </label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                                   id="dish-name-en" type="text" placeholder="例如: Boiled Beef in Spicy Broth">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="dish-category">
                                分类
                            </label>
                            <select class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                                    id="dish-category">
                                <!-- 分类选项将通过JavaScript动态添加 -->
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="dish-price">
                                价格
                            </label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                                   id="dish-price" type="number" step="0.01" placeholder="例如: 48.00">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                属性
                            </label>
                            <div class="flex items-center">
                                <input id="dish-spicy" type="checkbox" class="h-4 w-4 text-blue-600">
                                <label for="dish-spicy" class="ml-2 text-gray-700">辣</label>
                            </div>
                            <div class="flex items-center mt-2">
                                <input id="dish-vegetarian" type="checkbox" class="h-4 w-4 text-blue-600">
                                <label for="dish-vegetarian" class="ml-2 text-gray-700">素食</label>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                状态
                            </label>
                            <div class="flex items-center">
                                <input id="dish-available" type="checkbox" class="h-4 w-4 text-blue-600" checked>
                                <label for="dish-available" class="ml-2 text-gray-700">可用</label>
                            </div>
                        </div>
                        <!-- 图片上传区域 -->
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                菜品图片
                            </label>
                            <div id="image-upload-container">
                                <!-- 图片上传组件将通过JavaScript动态添加 -->
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button type="button" id="cancel-dish-btn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded mr-2">
                                取消
                            </button>
                            <button type="submit" id="save-dish-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                                保存
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 确认删除模态框 -->
        <div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">确认删除</h3>
                    <p class="text-gray-700 mb-4">您确定要删除这道菜品吗？此操作无法撤销。</p>
                    <div class="flex justify-end">
                        <button type="button" id="cancel-delete-btn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded mr-2">
                            取消
                        </button>
                        <button type="button" id="confirm-delete-btn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                            删除
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // 数据库配置
        const SUPABASE_URL = 'https://kdlhyzsihflwkwumxzfw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtkbGh5enNpaGZsd2t3dW14emZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0MjQxMjAsImV4cCI6MjA3NDAwMDEyMH0.wABs6L4Eiosksya2nUoO1i7doO7tYHcuz8WZA1kx6G8';
        
        // 创建Supabase客户端
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // 当前图片URL
        let currentImageUrl = '';

        // 获取分类数据
        async function fetchCategories() {
            try {
                const { data, error } = await supabase
                    .from('categories')
                    .select('*')
                    .order('sort');
                
                if (error) throw error;
                return data;
            } catch (error) {
                console.error('获取分类数据失败:', error);
                return [];
            }
        }

        // 获取菜品数据
        async function fetchDishes() {
            try {
                const { data, error } = await supabase
                    .from('dishes')
                    .select('*');
                
                if (error) throw error;
                return data;
            } catch (error) {
                console.error('获取菜品数据失败:', error);
                return [];
            }
        }

        // 初始化页面
        document.addEventListener('DOMContentLoaded', async function() {
            // 获取数据
            window.categories = await fetchCategories();
            window.dishes = await fetchDishes();
            
            // 填充分类筛选下拉框
            const categoryFilter = document.getElementById('category-filter');
            const dishCategorySelect = document.getElementById('dish-category');
            
            window.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.title_zh;
                categoryFilter.appendChild(option.cloneNode(true));
                dishCategorySelect.appendChild(option.cloneNode(true));
            });

            // 渲染菜品表格
            renderDishesTable(window.dishes);

            // 绑定事件
            document.getElementById('add-dish-btn').addEventListener('click', () => openAddDishModal(window.categories));
            document.getElementById('cancel-dish-btn').addEventListener('click', closeDishModal);
            document.getElementById('dish-form').addEventListener('submit', (e) => saveDish(e, window.categories));
            document.getElementById('cancel-delete-btn').addEventListener('click', closeDeleteModal);
            document.getElementById('confirm-delete-btn').addEventListener('click', confirmDeleteDish);
        });

        // 渲染菜品表格
        function renderDishesTable(dishesData) {
            const tableBody = document.getElementById('dishes-table-body');
            tableBody.innerHTML = '';

            dishesData.forEach(dish => {
                const category = window.categories.find(cat => cat.id === dish.category_id);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${dish.dish_id}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${dish.name_zh}</div>
                        <div class="text-sm text-gray-500">${dish.name_en}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${category ? category.title_zh : '未知'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">¥${dish.price.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${dish.is_spicy ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 mr-1">辣</span>' : ''}
                        ${dish.is_vegetarian ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">素食</span>' : ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${dish.available ? 
                            '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">可用</span>' : 
                            '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">不可用</span>'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="openEditDishModal('${dish.id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                            <i class="fas fa-edit"></i> 编辑
                        </button>
                        <button onclick="openDeleteDishModal('${dish.id}')" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // 打开添加菜品模态框
        function openAddDishModal(categories) {
            document.getElementById('modal-title').textContent = '添加菜品';
            document.getElementById('dish-form').reset();
            document.getElementById('dish-id').value = '';
            currentImageUrl = '';
            
            // 清空图片上传容器并添加上传组件
            const imageUploadContainer = document.getElementById('image-upload-container');
            imageUploadContainer.innerHTML = `
                <div class="flex items-center space-x-2">
                    <input type="file" id="dish-image-upload" accept="image/*" 
                        class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-50 file:text-blue-700
                        hover:file:bg-blue-100" />
                    <button id="upload-image-btn" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                        上传图片
                    </button>
                </div>
                <div id="upload-status" class="mt-2 text-sm text-gray-500 hidden"></div>
            `;
            
            // 绑定上传事件
            document.getElementById('upload-image-btn').addEventListener('click', handleImageUpload);
            
            document.getElementById('dish-modal').classList.remove('hidden');
        }

        // 打开编辑菜品模态框
        async function openEditDishModal(dishId) {
            const { data: dish, error } = await supabase
                .from('dishes')
                .select('*')
                .eq('id', dishId)
                .single();

            if (error) {
                console.error('获取菜品信息失败:', error);
                alert('获取菜品信息失败');
                return;
            }

            if (dish) {
                document.getElementById('modal-title').textContent = '编辑菜品';
                document.getElementById('dish-id').value = dish.id;
                document.getElementById('dish-dish-id').value = dish.dish_id;
                document.getElementById('dish-name-zh').value = dish.name_zh;
                document.getElementById('dish-name-en').value = dish.name_en;
                document.getElementById('dish-category').value = dish.category_id;
                document.getElementById('dish-price').value = dish.price;
                document.getElementById('dish-spicy').checked = dish.is_spicy;
                document.getElementById('dish-vegetarian').checked = dish.is_vegetarian;
                document.getElementById('dish-available').checked = dish.available;
                currentImageUrl = dish.image_url || '';
                
                // 清空图片上传容器并添加上传组件
                const imageUploadContainer = document.getElementById('image-upload-container');
                imageUploadContainer.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <input type="file" id="dish-image-upload" accept="image/*" 
                            class="block w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-50 file:text-blue-700
                            hover:file:bg-blue-100" />
                        <button id="upload-image-btn" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                            上传图片
                        </button>
                    </div>
                    <div id="upload-status" class="mt-2 text-sm text-gray-500 hidden"></div>
                    ${currentImageUrl ? `<div class="mt-2"><img src="${currentImageUrl}" alt="当前图片" class="w-16 h-16 object-cover rounded"></div>` : ''}
                `;
                
                // 绑定上传事件
                document.getElementById('upload-image-btn').addEventListener('click', handleImageUpload);
                
                document.getElementById('dish-modal').classList.remove('hidden');
            }
        }

        // 处理图片上传
        async function handleImageUpload() {
            const fileInput = document.getElementById('dish-image-upload');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('请选择要上传的图片');
                return;
            }
            
            // 显示上传状态
            const uploadStatus = document.getElementById('upload-status');
            uploadStatus.textContent = '正在上传...';
            uploadStatus.classList.remove('hidden');
            
            try {
                // 获取菜品ID
                const dishId = document.getElementById('dish-dish-id').value || 'temp';
                
                // 上传到 Supabase Storage
                const fileExt = file.name.split('.').pop();
                const fileName = `dishes/${dishId}.${fileExt}`;
                
                const { data, error } = await supabase.storage
                    .from('dish-images')
                    .upload(fileName, file, {
                        upsert: true
                    });

                if (error) {
                    throw error;
                }

                // 获取公开URL
                const { data: { publicUrl } } = supabase.storage
                    .from('dish-images')
                    .getPublicUrl(fileName);
                
                // 更新当前图片URL
                currentImageUrl = publicUrl;
                
                // 更新状态显示
                uploadStatus.textContent = '上传成功！';
                uploadStatus.classList.remove('text-gray-500');
                uploadStatus.classList.add('text-green-500');
                
                // 显示预览图片
                const imageUploadContainer = document.getElementById('image-upload-container');
                const existingPreview = imageUploadContainer.querySelector('.image-preview');
                if (existingPreview) {
                    existingPreview.remove();
                }
                
                const previewDiv = document.createElement('div');
                previewDiv.className = 'image-preview mt-2';
                previewDiv.innerHTML = `<img src="${publicUrl}" alt="预览图片" class="w-16 h-16 object-cover rounded">`;
                imageUploadContainer.appendChild(previewDiv);
                
                alert('图片上传成功！');
            } catch (error) {
                console.error('上传失败:', error);
                uploadStatus.textContent = '上传失败: ' + error.message;
                uploadStatus.classList.remove('text-gray-500');
                uploadStatus.classList.add('text-red-500');
                alert('图片上传失败: ' + error.message);
            }
        }

        // 关闭菜品模态框
        function closeDishModal() {
            document.getElementById('dish-modal').classList.add('hidden');
        }

        // 保存菜品
        async function saveDish(e, categories) {
            e.preventDefault();
            
            const id = document.getElementById('dish-id').value;
            const dishId = document.getElementById('dish-dish-id').value;
            const nameZh = document.getElementById('dish-name-zh').value;
            const nameEn = document.getElementById('dish-name-en').value;
            const categoryId = document.getElementById('dish-category').value;
            const price = parseFloat(document.getElementById('dish-price').value);
            const isSpicy = document.getElementById('dish-spicy').checked;
            const isVegetarian = document.getElementById('dish-vegetarian').checked;
            const available = document.getElementById('dish-available').checked;
            
            // 验证必填字段
            if (!dishId || !nameZh || !nameEn || !categoryId || isNaN(price)) {
                alert('请填写所有必填字段');
                return;
            }
            
            try {
                const dishData = {
                    dish_id: dishId,
                    name_zh: nameZh,
                    name_en: nameEn,
                    category_id: categoryId,
                    price: price,
                    is_spicy: isSpicy,
                    is_vegetarian: isVegetarian,
                    available: available,
                    image_url: currentImageUrl
                };
                
                let result;
                if (id) {
                    // 更新菜品
                    const { data, error } = await supabase
                        .from('dishes')
                        .update(dishData)
                        .eq('id', id);
                    
                    if (error) throw error;
                    result = data;
                } else {
                    // 添加菜品
                    const { data, error } = await supabase
                        .from('dishes')
                        .insert([dishData]);
                    
                    if (error) throw error;
                    result = data;
                }
                
                alert('菜品保存成功！');
                closeDishModal();
                
                // 重新加载数据
                window.dishes = await fetchDishes();
                renderDishesTable(window.dishes);
            } catch (error) {
                console.error('保存菜品失败:', error);
                alert('保存菜品失败: ' + error.message);
            }
        }

        // 打开删除菜品模态框
        function openDeleteDishModal(dishId) {
            window.currentDishId = dishId;
            document.getElementById('delete-modal').classList.remove('hidden');
        }

        // 关闭删除模态框
        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.add('hidden');
        }

        // 确认删除菜品
        async function confirmDeleteDish() {
            try {
                const { error } = await supabase
                    .from('dishes')
                    .delete()
                    .eq('id', window.currentDishId);
                
                if (error) throw error;
                
                alert('菜品删除成功！');
                closeDeleteModal();
                
                // 重新加载数据
                window.dishes = await fetchDishes();
                renderDishesTable(window.dishes);
            } catch (error) {
                console.error('删除菜品失败:', error);
                alert('删除菜品失败: ' + error.message);
            }
        }
        
        // 图片上传完成回调
        function onImageUploadComplete(imageUrl) {
            currentImageUrl = imageUrl;
            alert('图片上传成功！');
        }
    </script>
</body>
</html>